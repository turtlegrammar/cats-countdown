<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    td, p {
        font-size: 6vw;
    }
    td {
        text-align: center;
        width: 15%;
    }
    button {
        font-size: 3vw;
    }
    table {
        width: 90%;
    }
</style>

<html>
    <table>
        <tr>
            <td id="num-0">1</td>
            <td id="num-1">3</td>
            <td id="num-2">7</td>
            <td id="num-3">4</td>
            <td id="num-4">25</td>
            <td id="num-5">100</td>
        </tr>
    </table>
    <p id="target">Target: 341</p>
    <p id="solution">Solution: ???</p>
    <table>
        <tr>
            <td><button id="show-solution">Show Solution</button></td>
            <td><button id="gimme-another">Gimme Another</button></td>
        </tr>
    </table>
</html>

<script>
    /*
    https://ok-color-picker.netlify.app/#268350
    155 -> 25 in intervals of 13 for 10
    1. 155 = 268350
    2. 141 = 3d8232
    3. 127 = 5b7c1b
    4. 113 = 707613
    5. 99 = 7f7012
    6. 84 = 8c6911
    7. 69 = 99610f
    8. 54 = a7560f
    9. 40 = b64618
    10. 25 = c32f32

    */
    function getRngSeed() {
        const date = new Date();
        return 10000 * date.getFullYear() + 100 * date.getMonth() + date.getDate();
    }

    function getRng(seed) {
        // https://stackoverflow.com/a/47593316
        function sfc32(a, b, c, d) {
            return function () {
                a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
                var t = (a + b) | 0;
                a = b ^ b >>> 9;
                b = c + (c << 3) | 0;
                c = (c << 21 | c >>> 11);
                d = d + 1 | 0;
                t = t + d | 0;
                c = c + t | 0;
                return (t >>> 0) / 4294967296;
            }
        }

        return sfc32(0x9E3779B9, 0x243F6A88, 0xB7E15162, seed);
    }

    function takeRandom(rand, source, n) {
        // https://stackoverflow.com/a/12646864
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(rand() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        const shuffled = [ ... source];
        shuffleArray(shuffled);
        const taken = [];
        const remaining = [];
        for (let i = 0; i < shuffled.length; i++) {
            (i < n ? taken : remaining).push(shuffled[i]);
        }

        return [taken, remaining];
    }

    function takeRandomOne(rand, source) {
        const [x, y] = takeRandom(rand, source, 1);
        return [x[0], y];
    }

    function randomBool(rand) {
        return rand() < 0.5;
    }

    const makeNumber = n => ({value: n, type: 'number'});
    const makePlus = (l, r) => ({value: l.value + r.value, type: '+', left: l, right: r});
    const makeMinus = (l, r) => ({value: l.value - r.value, type: '-', left: l, right: r});
    const makeTimes = (l, r) => ({value: l.value * r.value, type: '*', left: l, right: r});
    const makeDivides = (l, r) => ({value: l.value / r.value, type: '/', left: l, right: r});

    function generateTarget(rand, nums, numberOfOps) {

        function allowedCombinations(leftVal, rightVal) {
            const allowed = [makePlus];
            if (leftVal * rightVal < 1000 && leftVal != 1 && rightVal != 1) {
                allowed.push(makeTimes);
            }
            if (leftVal - rightVal > 0) {
                allowed.push(makeMinus);
            }
            if (rightVal > 1 && leftVal % rightVal == 0) {
                allowed.push(makeDivides);
            }
            return allowed;
        }

        function go(target, numberOfOpsRemaining, pool) {
            // returns [target, newNumberOfOpsRemaining, newPool]
            function singleOp() {
                const [combineWith, rest] = takeRandomOne(rand, pool);
                const allowedOps = allowedCombinations(target.value, combineWith);
                return [takeRandomOne(rand, allowedOps)[0](target, makeNumber(combineWith)), numberOfOpsRemaining - 1, rest];
            }

            function doubleOp() {
                const [loveBirds, rest] = takeRandom(rand, pool, 2);
                const allowedCombosForLoveBirds = allowedCombinations(loveBirds[0], loveBirds[1]);
                const combinedLoveBird = takeRandomOne(rand, allowedCombosForLoveBirds)[0](makeNumber(loveBirds[0]), makeNumber(loveBirds[1]));
                const allowedCombos = allowedCombinations(target.value, combinedLoveBird.value);
                return [takeRandomOne(rand, allowedCombos)[0](target, combinedLoveBird), numberOfOpsRemaining - 2, rest];
            }

            if (numberOfOpsRemaining <= 0) {
                return target;
            } else  {
                const strategy = numberOfOpsRemaining == 1 ? singleOp : (randomBool(rand) ? singleOp : doubleOp);
                const [newTarget, nextNumberOfOpsRemaining, newPool] = strategy();

                return go(newTarget, nextNumberOfOpsRemaining, newPool);
            }
        }

        const [firstTarget, firstRest] = takeRandomOne(rand, nums);

        return go(makeNumber(firstTarget), numberOfOps, firstRest);
    }

    function generatePleasantTarget(rand, nums) {
        let i = 0;
        while (true) {
            i++;
            const target = generateTarget(rand, nums, takeRandomOne(rand, [3, 4, 5], 1)[0]);
            if (100 <= target.value && target.value <= 999) {
                return target;
            }
        }
    }
    
    function targetToString(target) {
        return target.type == 'number' ? target.value
            : target.type == '+' ? (targetToString(target.left) + ' + ' + targetToString(target.right))
            : target.type == '-' ? targetToString(target.left) + ' - ' + 
                ((target.right.type == '+' || target.right.type == '-') ? '(' + targetToString(target.right) + ')' : targetToString(target.right))
            : (
                ((target.left.type == '+' || target.left.type == '-') ? '(' + targetToString(target.left) + ')' : targetToString(target.left))
                + " " + target.type + " " +
                ((target.right.type == '+' || target.right.type == '-') ? '(' + targetToString(target.right) + ')' : targetToString(target.right))
            );
    }

    function findAllSolutions(pool, target) {

        alreadyEncountered = new Set();

        function combine(arr1, arr2, areSame, resultArr) {
            function addResult(n) {
                const x = n.value * 64 + n.membership;
                if (!alreadyEncountered.has(x)) {
                    resultArr.push(n);
                    alreadyEncountered.add(x);
                }
            }
            for (let i = 0; i < arr1.length; i++) {
                for (let j = (areSame ? i + 1 : 0); j < arr2.length; j++) {
                    const left = arr1[i];
                    const right = arr2[j];
                    const newMembership = left.membership | right.membership;
                    if ( (left.membership & right.membership) == 0) {
                        if (left.value + right.value < 1000) {
                            const p = makePlus(left, right);
                            p.membership = newMembership;
                            addResult(p);
                        }
        
                        if (left.value != 1 && right.value != 1 && left.value * right.value < 1000) {
                            const t = makeTimes(left, right);
                            t.membership = newMembership;
                            addResult(t);
                        }
        
                        if (left.value > right.value) {
                            const m = makeMinus(left, right);
                            m.membership = newMembership;
                            addResult(m);
                        }

                        if (right.value > left.value) {
                            const m = makeMinus(right, left);
                            m.membership = newMembership;
                            addResult(m);
                        }
        
                        if (left.value % right.value == 0 && right.value != 1) {
                            const d = makeDivides(left, right);
                            d.membership = newMembership;
                            addResult(d);
                        }

                        if (right.value % left.value == 0 && left.value != 1) {
                            const d = makeDivides(right, left);
                            d.membership = newMembership;
                            addResult(d);
                        }
                    }
                }
            }
        }

        const ones = pool.map(makeNumber);
        for (let i = 0; i < ones.length; i++) {
            ones[i].membership = 2**i;
        }


        const twos = [];
        combine(ones, ones, true, twos);

        const threes = [];
        combine(ones, twos, false, threes);

        const fours = [];
        combine(twos, twos, true, fours);
        combine(ones, threes, false, fours);

        const fives = [];
        combine(ones, fours, false, fives);
        combine(twos, threes, false, fives);

        const sixes = [];
        combine(ones, fives, false, sixes);
        combine(twos, fours, false, sixes);
        combine(threes, threes, true, sixes);

        // console.log("ones.length", ones.length);
        // console.log("twos.length", twos.length);
        // console.log("threes.length", threes.length);
        // console.log("fours.length", fours.length);
        // console.log("fives.length", fives.length);
        // console.log("sixes.length", sixes.length);

        const results = [];
        [ones, twos, threes, fours, fives, sixes].forEach(arr => {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i].value == target) {
                    results.push(arr[i]);
                }
            }
        });

        return results;
    }

    const rand = getRng(getRngSeed());
    const smallsPool = [1, 2, 3, 4, 5, 6, 7, 8, 9];
    const bigsPool = [25, 50, 75, 100];

    function setup() {
        document.getElementById("solution").textContent = "Solution: ???";

        const nums =  [... takeRandom(rand, smallsPool, 4)[0], ... takeRandom(rand, bigsPool, 2)[0]];

        const target = generatePleasantTarget(rand, nums);

        for (let i = 0; i < nums.length; i++) {
            document.getElementById("num-" + i).textContent = nums[i];
        }

        document.getElementById("target").textContent = "Target: " + target.value;

        const allSolutions = findAllSolutions(nums, target.value).map(targetToString);
        document.getElementById("show-solution").onclick = () => {
            document.getElementById("solution").innerHTML = "Solution(s): </br>" + allSolutions.join("</br>");
        }

        // console.log(target.value);
        // console.log(findAllSolutions(nums, target.value).map(targetToString));
    }

    document.getElementById("gimme-another").onclick = setup;

    setup();
</script>